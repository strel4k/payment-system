@startuml
!theme plain
skinparam responseMessageBelowArrow true
skinparam sequenceMessageAlign center
skinparam BoxPadding 10

title Deposit Flow — Two-Phase Async (Kafka)

actor User
participant "Individuals API" as API
participant "Transaction Service" as TS
database "Transaction DB" as DB
queue "Kafka" as K
participant "Tempo" as Tempo

autonumber

note over User, Tempo
  <b>Deposit Flow — Two-Phase Commit via Kafka</b>
  Fee: 0% | Status transitions: PENDING → COMPLETED
end note

== Phase 1: Init ==

User -> API ++: POST /v1/transactions/deposit/init\n{walletUid, amount}
API -> Tempo: Start span: deposit_init
API -> TS ++: POST /api/v1/transactions/deposit/init\n{walletUid, amount}

TS -> DB: SELECT wallet WHERE uid=walletUid\nAND userUid=currentUser
DB --> TS: wallet (ACTIVE, balance)

note over TS
  Calculate fee: 0%
  Generate requestUid (UUID)
  Store in cache (TTL 15 min)
end note

TS --> API --: 200 OK\n{requestUid, walletUid,\namount, fee=0, expiresAt}
API --> User --: 200 OK\n{requestUid, amount, fee, expiresAt}

== Phase 2: Confirm ==

User -> API ++: POST /v1/transactions/deposit/confirm\n{requestUid}
API -> Tempo: Start span: deposit_confirm
API -> TS ++: POST /api/v1/transactions/deposit/confirm\n{requestUid}

TS -> TS: Get from cache by requestUid

TS -> DB ++: BEGIN TRANSACTION
TS -> DB: INSERT INTO transactions\n(uid, walletUid, amount, fee=0,\ntype=DEPOSIT, status=PENDING)
DB --> TS: transaction created
TS -> DB: COMMIT
DB --> TS --: OK

TS -> K: publish deposit-requested\n{transactionUid, walletUid, amount}

TS --> API --: 201 Created\n{transactionUid, status=PENDING}
API --> User --: 201 Created\n{transactionUid, status=PENDING}

== Async Processing ==

K -> TS ++: consume deposit-completed\n{transactionUid, walletUid, amount}

TS -> DB ++: BEGIN TRANSACTION
TS -> DB: UPDATE wallets SET balance = balance + amount\nWHERE uid=walletUid
DB --> TS: OK
TS -> DB: UPDATE transactions SET status=COMPLETED\nWHERE uid=transactionUid
DB --> TS: OK
TS -> DB: COMMIT
DB --> TS --: OK

TS --> K --: ACK

API -> Tempo: End span: deposit\n(status=OK)

note over DB #lightgreen
  Wallet balance credited
  Transaction status: COMPLETED
end note

@enduml
