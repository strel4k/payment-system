# Transaction Service

ĞœĞ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ°Ğ¼Ğ¸ Ğ¸ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸ÑĞ¼Ğ¸ Ğ² Payment System.

## ğŸ¯ Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ

- **Wallet Management** â€” ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ°Ğ¼Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
- **Deposit** â€” Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ° (Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ´Ğ²ÑƒÑ…Ñ„Ğ°Ğ·Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ñ‡ĞµÑ€ĞµĞ· Kafka)
- **Withdrawal** â€” Ğ²Ñ‹Ğ²Ğ¾Ğ´ ÑÑ€ĞµĞ´ÑÑ‚Ğ² (Ğ¿Ğ¾Ğ»Ñƒ-ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ñ Kafka)
- **Transfer** â€” Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´ Ğ¼ĞµĞ¶Ğ´Ñƒ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ°Ğ¼Ğ¸ (ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğ¹)
- **Fee Calculation** â€” Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚ ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¹

## ğŸ—ï¸ ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Transaction Service                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Wallet API  â”‚  â”‚Transaction  â”‚  â”‚   Kafka Consumer    â”‚  â”‚
â”‚  â”‚ Controller  â”‚  â”‚ Controller  â”‚  â”‚  (Event Processing) â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                â”‚                    â”‚             â”‚
â”‚         â–¼                â–¼                    â–¼             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              Service Layer                              â”‚â”‚
â”‚  â”‚  WalletService â”‚ TransactionService â”‚ FeeCalculator     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚         â”‚                â”‚                     â”‚            â”‚
â”‚         â–¼                â–¼                     â–¼            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ PostgreSQL   â”‚  â”‚    Kafka     â”‚  â”‚   InitRequestCache  â”‚â”‚
â”‚  â”‚ (Wallets,    â”‚  â”‚  (Events)    â”‚  â”‚   (Two-phase TTL)   â”‚â”‚
â”‚  â”‚ Transactions)â”‚  â”‚              â”‚  â”‚                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¡ API Endpoints

### Wallets

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/v1/wallets` | Create new wallet |
| GET | `/api/v1/wallets/{uid}` | Get wallet by UID |
| GET | `/api/v1/wallets` | List user's wallets |

### Transactions

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/v1/transactions/deposit/init` | Initialize deposit |
| POST | `/api/v1/transactions/deposit/confirm` | Confirm deposit |
| POST | `/api/v1/transactions/withdrawal/init` | Initialize withdrawal |
| POST | `/api/v1/transactions/withdrawal/confirm` | Confirm withdrawal |
| POST | `/api/v1/transactions/transfer/init` | Initialize transfer |
| POST | `/api/v1/transactions/transfer/confirm` | Confirm transfer |
| GET | `/api/v1/transactions/{uid}` | Get transaction status |
| GET | `/api/v1/transactions` | List transactions |

## ğŸ’° Fee Structure

| Operation | Fee | Example |
|-----------|-----|---------|
| Deposit | 0% | 100 â†’ 100 credited |
| Withdrawal | 1% | 100 â†’ 99 received |
| Transfer | 0.5% | 100 â†’ 99.50 transferred |

## ğŸ”„ Transaction Flows

### Deposit (Asynchronous)
```
1. init â†’ returns requestUid + fee info (TTL 15 min)
2. confirm â†’ creates PENDING transaction â†’ sends Kafka event
3. Payment Gateway â†’ sends deposit-completed event
4. Kafka Consumer â†’ credits wallet â†’ status COMPLETED
```

### Withdrawal (Semi-synchronous)
```
1. init â†’ validates balance â†’ returns fee info
2. confirm â†’ debits balance immediately â†’ PENDING â†’ Kafka event
3. Payment Gateway â†’ sends completion/failure event
4. Consumer â†’ updates status (or refunds on failure)
```

### Transfer (Synchronous)
```
1. init â†’ validates source balance â†’ returns fee info
2. confirm â†’ atomic: debit source + credit target â†’ COMPLETED
```

## ğŸ”§ Configuration
```yaml
app:
  transaction:
    deposit-fee-percent: 0.00
    withdrawal-fee-percent: 0.01
    transfer-fee-percent: 0.005
    init-request-ttl-minutes: 15
```

## ğŸš€ Running

```bash
# Start dependencies
docker-compose up -d zookeeper kafka transaction-postgres keycloak

# Run service
./gradlew :transaction-service:bootRun

# Or via Docker
docker-compose up -d transaction-service
```

## ğŸ§ª Testing
```bash
./gradlew :transaction-service:test
# 35 tests: unit + integration
```

## ğŸ“Š Database Schema
```sql
wallet_types (uid, name, currency_code)
wallets (uid, user_uid, wallet_type_uid, name, status, balance)
transactions (uid, user_uid, wallet_uid, type, status, amount, fee, target_wallet_uid)
```
